#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
# See debhelper(7) (uncomment to enable)
# This is an autogenerated template for debian/rules.
#
# Output every command that modifies files on the build system.
export DH_VERBOSE = 1
#
# Copy some variable definitions from pkg-info.mk and vendor.mk
# under /usr/share/dpkg/ to here if they are useful.
#
# See FEATURE AREAS/ENVIRONMENT in dpkg-buildflags(1)
# Apply all hardening options
#export DEB_BUILD_MAINT_OPTIONS = hardening=+all
# Package maintainers to append CFLAGS
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
# Package maintainers to append LDFLAGS
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed
#
# With debhelper version 9 or newer, the dh command exports
# all buildflags.  So there is no need to include the
# /usr/share/dpkg/buildflags.mk file here if compat is 9 or newer.
#
# These are rarely used code. (START)
#
# The following include for *.mk magically sets miscellaneous
# variables while honoring existing values of pertinent
# environment variables:
#
# Architecture-related variables such as DEB_TARGET_MULTIARCH:
#include /usr/share/dpkg/architecture.mk
# Vendor-related variables such as DEB_VENDOR:
#include /usr/share/dpkg/vendor.mk
# Package-related variables such as DEB_DISTRIBUTION
#include /usr/share/dpkg/pkg-info.mk
#
# You may alternatively set them susing a simple script such as:
# DEB_VENDOR ?= $(shell dpkg-vendor --query  Vendor)
#
# These are rarely used code. (END)
#

# main packaging script based on dh7 syntax
%:
	dh $@  

# debmake generated override targets
# Use "make prefix=/usr" (override prefix=/usr/local in Makefile)
#override_dh_auto_install:
#	dh_auto_install -- prefix=/usr

override_dh_install:
	dh_install
	jq '.version = "'`dpkg-parsechangelog | sed -n 's/^Version: //p'| sed 's/~.*//'`'"'  debian/conf/composer.json |sponge debian/conf/composer.json
	sed -i '/__DIR__/c\require_once "/var/lib/composer/abraflexi-webhook-acceptor/autoload.php";' debian/abraflexi-webhook-acceptor/usr/share/abraflexi-webhook-acceptor/*.php
	sed -i -e 's/..\/vendor/\/var\/lib\/composer\/abraflexi-webhook-acceptor/g'   debian/abraflexi-webhook-acceptor/usr/share/abraflexi-webhook-acceptor/*.php
	sed -i -e 's/.\/vendor/\/var\/lib\/composer\/abraflexi-webhook-acceptor/g'    debian/abraflexi-webhook-acceptor/usr/lib/abraflexi-webhook-acceptor/phinx-adapter.php
	sed -i '/\.env/c\$$cfg="/etc\/abraflexi-webhook-acceptor\/.env";'  debian/abraflexi-webhook-acceptor/usr/lib/abraflexi-webhook-acceptor/phinx-adapter.php
	sed -i '/prefix =/c\ $$prefix = "\/usr\/lib\/abraflexi-webhook-acceptor\/db\/";' debian/abraflexi-webhook-acceptor/usr/lib/abraflexi-webhook-acceptor/phinx-adapter.php
	sed -i '/DB_DATABASE/c\ $$sqlOptions["database"] = "\/var\/lib\/dbconfig-common\/sqlite3\/abraflexi-webhook-acceptor\/".basename(\\Ease\\Functions::cfg("DB_DATABASE"));' debian/abraflexi-webhook-acceptor/usr/lib/abraflexi-webhook-acceptor/phinx-adapter.php
	sed -i -e 's/\.\.\/.env/\/etc\/abraflexi-webhook-acceptor\/\.env/g'  debian/abraflexi-webhook-acceptor/usr/lib/abraflexi-webhook-acceptor/phinx-adapter.php
	sed -i -e 's/..\/i18n/\/usr\/share\/locale/g'            	     debian/abraflexi-webhook-acceptor/usr/share/abraflexi-webhook-acceptor/*.php
	mkdir -p                                                             debian/abraflexi-webhook-acceptor-sqlite/usr/lib/abraflexi-webhook-acceptor
	cp debian/conf/.env.template                                         debian/abraflexi-webhook-acceptor-sqlite/usr/lib/abraflexi-webhook-acceptor
	mkdir -p                                                             debian/abraflexi-webhook-acceptor-mysql/usr/lib/abraflexi-webhook-acceptor
	cp debian/conf/.env.template                                         debian/abraflexi-webhook-acceptor-mysql/usr/lib/abraflexi-webhook-acceptor
	mkdir -p                                                             debian/abraflexi-webhook-acceptor-pgsql/usr/lib/abraflexi-webhook-acceptor
	cp debian/conf/.env.template                                         debian/abraflexi-webhook-acceptor-pgsql/usr/lib/abraflexi-webhook-acceptor
	sed -i '/DB_DATABASE/c\DB_DATABASE=_DBC_DBNAME_'                     debian/abraflexi-webhook-acceptor-*sql/usr/lib/abraflexi-webhook-acceptor/.env.template
